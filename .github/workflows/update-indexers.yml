name: Update Indexers List

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  repository_dispatch:
    types: [update-indexers]

env:
  DOCS_REPO: 'autobrr/autobrr.com'
  SOURCE_REPO: 'autobrr/autobrr'
  DOCS_PATH: 'autobrr.com'
  SOURCE_PATH: 'autobrr'

jobs:
  update-indexers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out autobrr.com repo
      uses: actions/checkout@v3
      with:
        repository: ${{ env.DOCS_REPO }}
        path: ${{ env.DOCS_PATH }}
        token: ${{ secrets.DOCS_TOKEN }}

    - name: Check out autobrr repo
      uses: actions/checkout@v3
      with:
        repository: ${{ env.SOURCE_REPO }}
        path: ${{ env.SOURCE_PATH }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Update indexers list
      run: |
        echo "Current directory structure:"
        pwd
        ls -la
        echo "${{ env.SOURCE_PATH }} contents:"
        ls -la ${{ env.SOURCE_PATH }}
        echo "${{ env.SOURCE_PATH }}/internal contents:"
        ls -la ${{ env.SOURCE_PATH }}/internal
        echo "${{ env.SOURCE_PATH }}/internal/indexer contents:"
        ls -la ${{ env.SOURCE_PATH }}/internal/indexer
        echo "${{ env.SOURCE_PATH }}/internal/indexer/definitions contents:"
        ls -la ${{ env.SOURCE_PATH }}/internal/indexer/definitions
        
        echo "Running update script..."
        cd ${{ env.SOURCE_PATH }}
        python3 scripts/update-indexers.py
        echo "Update script completed"
        echo "Generated files:"
        ls -l ../${{ env.DOCS_PATH }}/snippets/indexers.mdx ../${{ env.DOCS_PATH }}/snippets/freeleech.mdx || true

    - name: Install GitHub CLI
      run: |
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: Create Pull Request
      run: |
        cd ${{ env.DOCS_PATH }}
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "Current git status:"
        git status
        
        # Create a new branch
        BRANCH_NAME="update-indexers-$(date +%Y%m%d-%H%M%S)"
        echo "Creating branch: $BRANCH_NAME"
        git checkout -b $BRANCH_NAME
        
        echo "Changes to be added:"
        git status snippets/indexers.mdx snippets/freeleech.mdx
        
        # Add and commit changes
        git add snippets/indexers.mdx snippets/freeleech.mdx
        
        echo "Git status after adding files:"
        git status
        
        # Check if there are staged changes
        if git diff --cached --quiet; then
          echo "No changes detected in the files"
        else
          echo "Changes detected, creating commit and PR"
          git commit -m "docs: update indexers and freeleech support lists"
          
          echo "Pushing changes..."
          git push origin $BRANCH_NAME
          
          echo "Creating PR..."
          gh pr create \
            --repo ${{ env.DOCS_REPO }} \
            --base main \
            --head $BRANCH_NAME \
            --title "docs: update indexers and freeleech support lists" \
            --body "Automated update of the indexers and freeleech support lists from definitions" \
            --label "documentation"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.DOCS_TOKEN }}